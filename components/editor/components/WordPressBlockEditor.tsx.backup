'use client';

import React, { useState, useEffect, useCallback, useMemo, useRef } from 'react';
import { ClientOnlyGutenbergEditorProps, GutenbergBlock } from '../types';
import { useWordPressComponents } from '../hooks/useWordPressComponents';
import { useBlockManagement } from '../hooks/useBlockManagement';
import { useImageSearch } from '../hooks/useImageSearch';
import { convertHtmlToBlocks } from '../utils/htmlParser';
import { getBlockEditorSettings } from '../utils/blockEditorSettings';
import { ParagraphIcon, HeadingIcon, ImageIcon, ListIcon, QuoteIcon, SeparatorIcon } from '../icons/BlockIcons';

// Import existing components
import ImageSearchModal from '../../ImageSearchModal';
import CropModal from '../../CropModal';

// Debounce utility function
function debounce<T extends (...args: any[]) => any>(func: T, wait: number): T & { cancel: () => void } {
  let timeout: NodeJS.Timeout;
  const debounced = ((...args: any[]) => {
    clearTimeout(timeout);
    timeout = setTimeout(() => func(...args), wait);
  }) as T & { cancel: () => void };
  
  debounced.cancel = () => {
    clearTimeout(timeout);
  };
  
  return debounced;
}

function WordPressBlockEditor({ 
  post, 
  onSave, 
  onCancel 
}: ClientOnlyGutenbergEditorProps) {
  console.log('üöÄ WordPressBlockEditor rendered', { post: !!post, onSave: !!onSave, onCancel: !!onCancel });
  
  // Add debugging for post data
  useEffect(() => {
    if (post) {
      console.log('üîç Post data received:', post);
      console.log('üìÑ Post content:', post.content);
      console.log('üìÑ Post content length:', post.content?.length);
      console.log('üìÑ Post content type:', typeof post.content);
      console.log('üìÑ Post content raw:', JSON.stringify(post.content));
      
      // Check if post has block-based content (Gutenberg blocks)
      if (post.blocks && Array.isArray(post.blocks)) {
        console.log('üß± Post has block data:', post.blocks.length, 'blocks');
        console.log('üß± First few blocks:', post.blocks.slice(0, 3));
      } else if (post.content && typeof post.content === 'object') {
        // Check for WordPress REST API content structure
        if (post.content.raw) {
          console.log('üìÑ Post has raw content:', post.content.raw);
        }
        if (post.content.rendered) {
          console.log('üìÑ Post has rendered content:', post.content.rendered);
        }
      }
      
      // Check if content is empty or malformed
      const contentToCheck = typeof post.content === 'object' 
        ? (post.content.rendered || post.content.raw) 
        : post.content;
        
      if (contentToCheck === '<p>[]</p>' || contentToCheck === '<p></p>' || !contentToCheck || contentToCheck.trim() === '') {
        console.log('‚ö†Ô∏è Post content is empty or malformed, this might indicate the WordPress post has no content or is using blocks');
        
        // Check if there's any other content we can use
        if (post.excerpt && typeof post.excerpt === 'object' && post.excerpt.rendered) {
          console.log('üìÑ Excerpt available:', post.excerpt.rendered);
        } else if (typeof post.excerpt === 'string' && post.excerpt) {
          console.log('üìÑ Excerpt available (string):', post.excerpt);
        }
      }
    }
  }, [post]);
  
  const [isClient, setIsClient] = useState(false);
  const [showCropModal, setShowCropModal] = useState(false);
  const [currentImageToCrop, setCurrentImageToCrop] = useState<any>(null);
  const [currentBlockId, setCurrentBlockId] = useState<string | null>(null);
  const [showBlockInserter, setShowBlockInserter] = useState(false);
  const [inserterPosition, setInserterPosition] = useState<{ index: number; x: number; y: number; popupX: number; popupY: number } | null>(null);
  const [inserterSearchQuery, setInserterSearchQuery] = useState('');
  const [showImageResults, setShowImageResults] = useState(false);
  const [pendingImageInsertion, setPendingImageInsertion] = useState<{ index: number } | null>(null);
  const [cropLoading, setCropLoading] = useState(false);
  const [inserterImages, setInserterImages] = useState<any[]>([]);
  const [inserterPage, setInserterPage] = useState(1);
  const [inserterHasMore, setInserterHasMore] = useState(false);
  const [inserterLoading, setInserterLoading] = useState(false);

  // Block types for inserter
  const blockTypes = [
    { name: 'core/paragraph', title: 'Paragraph', icon: ParagraphIcon, description: 'Start with the building block of all narrative.' },
    { name: 'core/heading', title: 'Heading', icon: HeadingIcon, description: 'Introduce new sections and organize content.' },
    { name: 'core/image', title: 'Image', icon: ImageIcon, description: 'Insert an image to make a visual statement.' },
    { name: 'core/list', title: 'List', icon: ListIcon, description: 'Create a bulleted or numbered list.' },
    { name: 'core/quote', title: 'Quote', icon: QuoteIcon, description: 'Give quoted text visual emphasis.' },
    { name: 'core/separator', title: 'Separator', icon: SeparatorIcon, description: 'Create a break between ideas or sections.' },
  ];

  // Position popup at the top of the content container
  const calculatePopupPosition = () => {
    const popupWidth = 650;
    const margin = 20;
    
    // Get viewport dimensions
    const viewportWidth = window.innerWidth;
    
    // Calculate horizontal position (centered)
    let popupX = (viewportWidth - popupWidth) / 2;
    
    // Ensure popup doesn't go off the edges
    if (popupX < margin) {
      popupX = margin;
    }
    if (popupX + popupWidth > viewportWidth - margin) {
      popupX = viewportWidth - popupWidth - margin;
    }
    
    // Position at the top of the content area
    const popupY = 100; // Fixed position from top of viewport
    
    return { popupX, popupY };
  };

  // Handle block insertion
  const handleInsertBlock = (blockType: string, index: number) => {
    console.log('Inserting block:', blockType, 'at index:', index);
    
    let attributes = {};
    switch (blockType) {
      case 'core/paragraph':
        attributes = { content: 'New paragraph' };
        break;
      case 'core/heading':
        attributes = { content: 'New heading', level: 2 };
        break;
      case 'core/image':
        attributes = { url: '', alt: '', caption: '' };
        break;
      case 'core/list':
        attributes = { values: '<li>List item</li>', ordered: false };
        break;
      case 'core/quote':
        attributes = { value: '<p>Quote text</p>', citation: '' };
        break;
      case 'core/separator':
        attributes = {};
        break;
      default:
        attributes = { content: 'New block' };
    }
    
    addBlock(blockType, attributes, index);
    setShowBlockInserter(false);
    setInserterPosition(null);
  };




  // Handle image selection from inserter
  const handleInserterImageSelect = (image: any) => {
    if (!inserterPosition) return;
    
    console.log('üñºÔ∏è Image selected for cropping:', image);
    console.log('üìç Insertion position:', inserterPosition);
    
    // Set the image for cropping and the target block ID
    setCurrentImageToCrop(image);
    setCurrentBlockId(`block-${Date.now()}-${inserterPosition.index}`);
    setPendingImageInsertion({ index: inserterPosition.index });
    
    // Close the inserter and open crop modal
    setShowBlockInserter(false);
    setInserterPosition(null);
    setShowImageResults(false);
    setInserterSearchQuery('');
    setShowCropModal(true);
    
    console.log('üé¨ Crop modal should now be open');
  };

  // Handle click outside to close inserter
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (showBlockInserter && 
          !(event.target as Element).closest('.block-editor-inserter__popover') && 
          !(event.target as Element).closest('.block-editor-block-list__insertion-point')) {
        setShowBlockInserter(false);
        setInserterPosition(null);
        setShowImageResults(false);
        setInserterSearchQuery('');
        setPendingImageInsertion(null);
        setInserterImages([]);
        setInserterPage(1);
        setInserterHasMore(false);
      }
    };

    if (showBlockInserter) {
      document.addEventListener('mousedown', handleClickOutside);
      return () => document.removeEventListener('mousedown', handleClickOutside);
    }
  }, [showBlockInserter]);

  // Handle window resize to reposition popup
  useEffect(() => {
    const handleResize = () => {
      if (showBlockInserter && inserterPosition) {
        const { popupX, popupY } = calculatePopupPosition();
        setInserterPosition(prev => prev ? { ...prev, popupX, popupY } : null);
      }
    };

    if (showBlockInserter) {
      window.addEventListener('resize', handleResize);
      return () => {
        window.removeEventListener('resize', handleResize);
      };
    }
  }, [showBlockInserter, inserterPosition]);

  // Custom hooks
  const { components: WordPressComponents, isLoading: componentsLoading } = useWordPressComponents();
  
  // Destructure WordPress components with proper validation
  const {
    BlockEditorProvider,
    BlockList,
    SlotFillProvider,
    Button
    // Temporarily disabled to fix React error
    // BlockInserter,
    // Inserter,
    // BlockAppender
  } = WordPressComponents || {};

  // Validate that components are functions
  const isValidComponent = (component: any) => {
    return component && typeof component === 'function' && component !== null && component !== undefined;
  };

  // Debug: Log component types
  console.log('üîç Component validation:', {
    SlotFillProvider: typeof SlotFillProvider,
    BlockEditorProvider: typeof BlockEditorProvider,
    BlockList: typeof BlockList,
    Button: typeof Button,
    WordPressComponents: !!WordPressComponents
  });
  const { 
    blocks, 
    setBlocks, 
    title, 
    setTitle, 
    handleSave, 
    addBlock 
  } = useBlockManagement(post, onSave);
  const {
    showImageSearch,
    setShowImageSearch,
    searchImages,
    searchLoading,
    selectedSources,
    hasMoreImages,
    lastSearchQuery,
    handleImageSearch,
    handleSourceToggle,
    openImageSearch,
    closeImageSearch
  } = useImageSearch();

  // Handle image search from inserter
  const handleInserterImageSearch = async (query: string, page: number = 1, append: boolean = false) => {
    if (!query.trim()) {
      setShowImageResults(false);
      setInserterImages([]);
      return;
    }
    
    setInserterSearchQuery(query);
    setShowImageResults(true);
    setInserterLoading(true);
    
    try {
      const response = await fetch(`/api/search-images?query=${encodeURIComponent(query)}&sources=${selectedSources.join(',')}&page=${page}&perPage=20`);
      const data = await response.json();
      
      if (append) {
        setInserterImages(prev => [...prev, ...data.images]);
      } else {
        setInserterImages(data.images);
      }
      
      setInserterHasMore(data.hasMore);
      setInserterPage(page);
    } catch (error) {
      console.error('Image search error:', error);
    } finally {
      setInserterLoading(false);
    }
  };

  // Handle load more images
  const handleLoadMoreImages = () => {
    if (inserterSearchQuery.trim() && !inserterLoading && inserterHasMore) {
      handleInserterImageSearch(inserterSearchQuery, inserterPage + 1, true);
    }
  };

  // Re-search when selectedSources changes and there's an active search
  useEffect(() => {
    if (inserterSearchQuery.trim() && showImageResults) {
      setInserterPage(1);
      handleInserterImageSearch(inserterSearchQuery, 1, false);
    }
  }, [selectedSources, inserterSearchQuery, showImageResults]);

  // Ensure we're on the client side
  useEffect(() => {
    console.log('üåê Setting isClient to true');
    setIsClient(true);
  }, []);

  // Track if we've already initialized to prevent infinite loops
  const initializedRef = useRef(false);
  const blocksRef = useRef<GutenbergBlock[]>([]);


  // Keep blocks ref in sync with blocks state - this must run BEFORE initializeEditor
  useEffect(() => {
    blocksRef.current = blocks;
    console.log('üíæ Updated blocks ref with', blocks.length, 'blocks');
  }, [blocks]);

  // Initialize editor when WordPress components are ready
  useEffect(() => {
    if (!WordPressComponents || !post) {
      console.log('‚è≥ Waiting for WordPress components or post data');
      return;
    }

    if (initializedRef.current) {
      console.log('‚ö†Ô∏è Editor already initialized, skipping');
      return;
    }

    // Check if we have blocks in the ref (preserved from previous state) - do this FIRST
    if (blocksRef.current.length > 0) {
      console.log('üîÑ Restoring blocks from ref:', blocksRef.current.length, 'blocks');
      setBlocks(blocksRef.current);
      return;
    }
    
    // Only initialize blocks if they're empty (don't reset existing blocks)
    if (blocks.length > 0) {
      console.log('‚ö†Ô∏è Blocks already exist, skipping initialization to preserve changes');
      return;
    }

    const initializeEditor = async () => {
      console.log('üìù Initializing editor with post data');
      initializedRef.current = true;
      setTitle(post.title || '');
      
      // Handle different content types from WordPress
      let contentToProcess = '';
      
      // Check if post has block-based content first
      if (post.blocks && Array.isArray(post.blocks) && post.blocks.length > 0) {
        console.log('üß± Post has block data, using blocks directly');
        setBlocks(post.blocks);
        return;
      }
      
      // Handle WordPress REST API content structure
      if (post.content && typeof post.content === 'object') {
        if (post.content.raw && post.content.raw.trim()) {
          contentToProcess = post.content.raw;
          console.log('üìÑ Using raw content from WordPress API');
        } else if (post.content.rendered && post.content.rendered.trim()) {
          contentToProcess = post.content.rendered;
          console.log('üìÑ Using rendered content from WordPress API');
        }
      } else if (typeof post.content === 'string') {
        contentToProcess = post.content;
        console.log('üìÑ Using string content');
      }

      if (contentToProcess) {
        try {
          console.log('üîç Parsing post content...');
          console.log('üìÑ Raw post content:', contentToProcess);
          console.log('üìÑ Post content length:', contentToProcess.length);
          
          // Check if content is empty or just contains empty tags
          const cleanContent = contentToProcess.trim();
          if (!cleanContent || 
              cleanContent === '<p></p>' || 
              cleanContent === '<p>[]</p>' || 
              cleanContent === '<p> </p>' ||
              cleanContent === '<p>&nbsp;</p>' ||
              cleanContent === '<p><br></p>' ||
              cleanContent === '<p><br/></p>' ||
              cleanContent === '<p><br /></p>') {
            console.log('‚ö†Ô∏è Post content is empty or contains only empty tags, checking for alternative content');
            
            // Try to use excerpt if available, otherwise use default text
            let defaultContent = 'Start writing...';
            let excerptToUse = '';
            
            if (post.excerpt && typeof post.excerpt === 'object' && post.excerpt.rendered) {
              excerptToUse = post.excerpt.rendered;
            } else if (typeof post.excerpt === 'string') {
              excerptToUse = post.excerpt;
            }
            
            if (excerptToUse && excerptToUse.trim() && excerptToUse !== '<p></p>') {
              // Strip HTML from excerpt and use as content
              const excerptText = excerptToUse.replace(/<[^>]*>/g, '').trim();
              if (excerptText) {
                defaultContent = excerptText;
                console.log('üìù Using excerpt as content:', excerptText);
              }
            }
            
            setBlocks([{
              clientId: `block-${Date.now()}-0`,
              name: 'core/paragraph',
              isValid: true,
              attributes: {
                content: defaultContent,
                dropCap: false
              },
              innerBlocks: []
            }]);
            return;
          }
          
          const parsedBlocks = WordPressComponents.parse(post.content);
          console.log('‚úÖ Parsed blocks:', parsedBlocks.length);
          console.log('üìã Parsed blocks details:', parsedBlocks);
          
          if (parsedBlocks.length === 0) {
            console.log('‚ö†Ô∏è No blocks parsed - content might be in HTML format, manually converting HTML to blocks');
            // Manually convert HTML to blocks
            try {
              const manualBlocks = convertHtmlToBlocks(contentToProcess);
              console.log('üîß Manually converted blocks:', manualBlocks.length);
              setBlocks(manualBlocks);
            } catch (error) {
              console.error('‚ùå Error in manual HTML conversion:', error);
              // Create a default paragraph block with the actual content
              const textContent = contentToProcess.replace(/<[^>]*>/g, '').trim();
              setBlocks([{
                clientId: `block-${Date.now()}-0`,
                name: 'core/paragraph',
                isValid: true,
                attributes: {
                  content: textContent || 'Start writing...',
                  dropCap: false
                },
                innerBlocks: []
              }]);
            }
          } else {
            setBlocks(parsedBlocks);
          }
        } catch (error) {
          console.error('‚ùå Error parsing post content:', error);
          // Create a default paragraph block with the actual content
          const textContent = contentToProcess.replace(/<[^>]*>/g, '').trim();
          setBlocks([{
            clientId: `block-${Date.now()}-0`,
            name: 'core/paragraph',
            isValid: true,
            attributes: {
              content: textContent || 'Start writing...',
              dropCap: false
            },
            innerBlocks: []
          }]);
        }
      } else {
        // No content, create a default paragraph block
        setBlocks([{
          clientId: `block-${Date.now()}-0`,
          name: 'core/paragraph',
          isValid: true,
          attributes: {
            content: 'Start writing...',
            dropCap: false
          },
          innerBlocks: []
        }]);
      }
      
      console.log('üìÑ Post object:', post);
    };

    initializeEditor();
  }, [WordPressComponents, post, blocks]);

  // Image handling functions
  const handleImageSelect = (image: any) => {
    console.log('üñºÔ∏è Image selected from search modal:', image);
    
    // Set the image for cropping and generate a new block ID
    setCurrentImageToCrop(image);
    setCurrentBlockId(`block-${Date.now()}-search`);
    setPendingImageInsertion(null); // Clear any pending insertion, will insert at end
    setShowImageSearch(false);
    setShowCropModal(true);
  };

  const handleCropConfirm = useCallback(async (croppedImageUrl: string) => {
    console.log('üé¨ handleCropConfirm called:', { 
      croppedImageUrl, 
      currentImageToCrop, 
      currentBlockId
    });
    
    if (!currentImageToCrop || !currentBlockId) {
      console.warn('‚ùå Missing required data for crop confirm');
      return;
    }
    
    setCropLoading(true);
    try {
      // Upload the cropped image
      const response = await fetch(croppedImageUrl);
      if (!response.ok) {
        throw new Error(`Failed to fetch cropped image: ${response.status}`);
      }
      const blob = await response.blob();
      const file = new File([blob], 'cropped-image.jpg', { type: 'image/jpeg' });
      
      let finalUrl = croppedImageUrl;
      
      // Try to upload to WordPress if available
      if (window.wordPressUpload) {
        try {
          const media = await window.wordPressUpload(file);
          finalUrl = media.source_url;
          console.log('‚úÖ WordPress upload successful:', finalUrl);
        } catch (error) {
          console.error('WordPress upload failed, using local URL:', error);
        }
      } else {
        // Fallback to local upload
        try {
          const formData = new FormData();
          formData.append('image', file);
          const uploadResponse = await fetch('/api/upload-image', {
            method: 'POST',
            body: formData,
          });
          if (uploadResponse.ok) {
            const result = await uploadResponse.json();
            finalUrl = result.url;
            console.log('‚úÖ Local upload successful:', finalUrl);
          } else {
            console.warn('Local upload failed, using blob URL');
          }
        } catch (error) {
          console.error('Local upload failed:', error);
        }
      }
      
      // Create caption with attribution for Unsplash, Pexels, and Wikimedia Commons images
      let imageCaption = '';
      let imageAlt = currentImageToCrop.caption || ''; // Use original caption for alt text
      
      if (currentImageToCrop.attribution && (currentImageToCrop.source === 'unsplash' || currentImageToCrop.source === 'pexels' || currentImageToCrop.source === 'wikiCommons')) {
        imageCaption = currentImageToCrop.attribution; // Show photographer attribution in caption
      }

      // Get current blocks and pending insertion data
      setBlocks(prevBlocks => {
        const existingBlock = prevBlocks.find(block => block.clientId === currentBlockId);
        console.log('üîç Block insertion check:', { existingBlock, currentBlockId, blocksCount: prevBlocks.length });
      
      if (existingBlock) {
        // Update existing block
          console.log('‚ûï Updating existing block');
          return prevBlocks.map(block => 
          block.clientId === currentBlockId 
            ? { ...block, attributes: { ...block.attributes, url: finalUrl, alt: imageAlt, caption: imageCaption } }
            : block
      );
      } else {
        // Insert new image block
          console.log('‚ûï Inserting new image block');
        const imageBlock = {
          clientId: currentBlockId,
          name: 'core/image',
          isValid: true,
          attributes: {
            url: finalUrl,
            alt: imageAlt,
            caption: imageCaption
          },
          innerBlocks: []
        };
        
        // Use the pending insertion position or default to end
          const insertionIndex = pendingImageInsertion?.index ?? prevBlocks.length;
          console.log('üìç Insertion details:', { insertionIndex, pendingImageInsertion, blocksLength: prevBlocks.length });
          
          const newBlocks = [...prevBlocks];
        newBlocks.splice(insertionIndex, 0, imageBlock);
          console.log('üìã New blocks after insertion:', newBlocks.length, 'blocks');
          return newBlocks;
      }
      });
      
      console.log('‚úÖ Crop confirm completed successfully');
      setShowCropModal(false);
      setCurrentImageToCrop(null);
      setCurrentBlockId(null);
      setPendingImageInsertion(null);
    } catch (error) {
      console.error('‚ùå Error processing cropped image:', error);
      // Don't close the modal on error, let user try again
    } finally {
      setCropLoading(false);
    }
  }, [currentImageToCrop, currentBlockId, pendingImageInsertion, setBlocks]);

  // All hooks must be called before any conditional returns
  const blockEditorSettings = useMemo(() => getBlockEditorSettings(), []);

  // Convert our blocks to WordPress format
  const convertBlocksToWordPressFormat = useCallback((blocks: GutenbergBlock[]) => {
    return blocks.map(block => ({
      clientId: block.clientId,
      name: block.name,
      isValid: block.isValid,
      attributes: block.attributes,
      innerBlocks: block.innerBlocks || []
    }));
  }, []);

  const wordPressBlocks = useMemo(() => convertBlocksToWordPressFormat(blocks), [blocks, convertBlocksToWordPressFormat]);

  // Handle block changes
  const handleBlocksChange = useCallback((newBlocks: any) => {
    console.log('üîÑ Blocks changed:', newBlocks);
    // Convert back to our format if needed
    setBlocks(newBlocks as GutenbergBlock[]);
  }, [setBlocks]);

  // Refs for tracking cursor position and preventing re-renders
  const cursorPositionRef = useRef<{ [key: string]: number }>({});
  const isUpdatingRef = useRef<{ [key: string]: boolean }>({});

  // Handle paragraph input changes with optimized cursor preservation
  const handleParagraphInput = useCallback((blockId: string, newContent: string, element: HTMLElement) => {
    // Prevent updates during React re-renders
    if (isUpdatingRef.current[blockId]) return;
    
    // Save cursor position
    const selection = window.getSelection();
    if (selection && selection.rangeCount > 0) {
      const range = selection.getRangeAt(0);
      cursorPositionRef.current[blockId] = range.startOffset;
    }

    // Update blocks state
    setBlocks(prevBlocks =>
      prevBlocks.map(b =>
        b.clientId === blockId ? { ...b, attributes: { ...b.attributes, content: newContent } } : b
      )
    );
  }, [setBlocks]);

  // Handle heading input changes with optimized cursor preservation
  const handleHeadingInput = useCallback((blockId: string, newContent: string, element: HTMLElement) => {
    // Prevent updates during React re-renders
    if (isUpdatingRef.current[blockId]) return;
    
    // Save cursor position
    const selection = window.getSelection();
    if (selection && selection.rangeCount > 0) {
      const range = selection.getRangeAt(0);
      cursorPositionRef.current[blockId] = range.startOffset;
    }

    // Update blocks state
    setBlocks(prevBlocks =>
      prevBlocks.map(b =>
        b.clientId === blockId ? { ...b, attributes: { ...b.attributes, content: newContent } } : b
      )
    );
  }, [setBlocks]);

  // Restore cursor position after re-render
  const restoreCursorPosition = useCallback((blockId: string, element: HTMLElement) => {
    const savedPosition = cursorPositionRef.current[blockId];
    if (savedPosition !== undefined) {
      isUpdatingRef.current[blockId] = true;
      
      setTimeout(() => {
        try {
          const selection = window.getSelection();
          if (selection) {
            const range = document.createRange();
            const textNode = element.childNodes[0] || element;
            const maxPosition = textNode.textContent?.length || 0;
            const position = Math.min(savedPosition, maxPosition);
            
            range.setStart(textNode, position);
            range.setEnd(textNode, position);
            selection.removeAllRanges();
            selection.addRange(range);
          }
        } catch (error) {
          console.error('Failed to restore cursor position:', error);
        } finally {
          isUpdatingRef.current[blockId] = false;
        }
      }, 0);
    }
  }, []);

  // Clean up cursor position tracking when blocks change
  useEffect(() => {
    const currentBlockIds = new Set(blocks.map(block => block.clientId));
    
    // Remove cursor positions for blocks that no longer exist
    Object.keys(cursorPositionRef.current).forEach(blockId => {
      if (!currentBlockIds.has(blockId)) {
        delete cursorPositionRef.current[blockId];
        delete isUpdatingRef.current[blockId];
      }
    });
  }, [blocks]);

  // Handle list input changes
  const handleListInput = useCallback((blockId: string, newContent: string) => {
    setBlocks(prevBlocks => 
      prevBlocks.map(b => 
        b.clientId === blockId 
          ? { ...b, attributes: { ...b.attributes, values: newContent } }
          : b
      )
    );
  }, []);

  // Handle quote input changes
  const handleQuoteInput = useCallback((blockId: string, newContent: string) => {
    setBlocks(prevBlocks => 
      prevBlocks.map(b => 
        b.clientId === blockId 
          ? { ...b, attributes: { ...b.attributes, value: newContent } }
          : b
      )
    );
  }, []);



  // Show loading while checking client side or loading WordPress components
  if (!isClient || componentsLoading || !WordPressComponents) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
        <span className="ml-3 text-gray-600">
          Loading WordPress Editor... 
          {!isClient && ' (Client)'}
          {componentsLoading && ' (Loading)'}
          {!WordPressComponents && ' (Components)'}
        </span>
      </div>
    );
  }

  // Additional safety check - ensure components are valid functions before rendering
  if (!isValidComponent(SlotFillProvider) || !isValidComponent(BlockEditorProvider)) {
    console.log('‚ö†Ô∏è WordPress components not ready, showing fallback UI');
    return (
      <div className="editor-visual-editor">
        <div className="editor-styles-wrapper block-editor-writing-flow">
          <div 
            className="editor-visual-editor__post-title-wrapper edit-post-visual-editor__post-title-wrapper has-global-padding"
            style={{
              maxWidth: '632px',
              margin: '33px auto 0 auto',
              padding: '0 20px'
            }}
          >
            <h1 
              contentEditable
              suppressContentEditableWarning
              className="wp-block wp-block-post-title block-editor-block-list__block editor-post-title editor-post-title__input rich-text"
              aria-label="Add title"
              onInput={(e) => setTitle(e.currentTarget.textContent || '')}
              style={{ 
                fontSize: 'var(--wp--preset--font-size--x-large)',
                fontWeight: 'bold',
                lineHeight: '1.2',
                margin: '0',
                padding: '0',
                border: 'none',
                outline: 'none',
                backgroundColor: 'transparent',
                textAlign: 'left',
                minHeight: '1.2em',
                whiteSpace: 'pre-wrap'
              }}
            >
              {title || 'Add title'}
            </h1>
          </div>

          <div 
            className="is-root-container is-desktop-preview is-layout-constrained wp-block-post-content-is-layout-constrained has-global-padding wp-block-post-content has-global-padding block-editor-block-list__layout"
            style={{
              maxWidth: '650px',
              margin: '0 auto',
              padding: '0 20px'
            }}
          >
            <div className="block-editor-block-list__layout" data-is-drop-zone="true">
              {blocks.map((block, index) => (
                <div key={`${block.clientId}-${block.name}`}>
                  <div 
                    className="block-editor-block-list__insertion-point"
                    onClick={(e) => {
                      const rect = e.currentTarget.getBoundingClientRect();
                      const clickX = rect.left + rect.width / 2;
                      const clickY = rect.top;
                      const { popupX, popupY } = calculatePopupPosition();
                      
                      setInserterPosition({ 
                        index, 
                        x: clickX, 
                        y: clickY,
                        popupX,
                        popupY
                      });
                      setShowBlockInserter(true);
                    }}
                  >
                    <div className="plus-icon"></div>
                  </div>
                  
                  <div style={{ marginBottom: '1rem' }}>
                    {block.name === 'core/paragraph' && (
                      <div
                        key={`paragraph-${block.clientId}`}
                        contentEditable
                        suppressContentEditableWarning
                        onInput={(e) => {
                          const newContent = e.currentTarget.textContent || '';
                          handleParagraphInput(block.clientId, newContent, e.currentTarget);
                        }}
                        onFocus={(e) => {
                          e.currentTarget.style.border = '1px solid #007cba';
                        }}
                        onBlur={(e) => {
                          e.currentTarget.style.border = '1px solid transparent';
                        }}
                        ref={(el) => {
                          if (el) {
                            restoreCursorPosition(block.clientId, el);
                          }
                        }}
                        style={{
                          minHeight: '1.5em',
                          outline: 'none',
                          border: '1px solid transparent',
                          background: 'transparent',
                          width: '100%',
                          fontSize: 'var(--wp--preset--font-size--medium)',
                          lineHeight: '1.5',
                          padding: '8px',
                          borderRadius: '4px',
                          direction: 'ltr',
                          unicodeBidi: 'normal'
                        }}
                      >
                        {block.attributes.content || 'Start writing...'}
                      </div>
                    )}

                    {block.name === 'core/heading' && (
                      <h2
                        key={`heading-${block.clientId}`}
                        contentEditable
                        suppressContentEditableWarning
                        onInput={(e) => {
                          const newContent = e.currentTarget.textContent || '';
                          handleHeadingInput(block.clientId, newContent, e.currentTarget);
                        }}
                        onFocus={(e) => {
                          e.currentTarget.style.border = '1px solid #007cba';
                        }}
                        onBlur={(e) => {
                          e.currentTarget.style.border = '1px solid transparent';
                        }}
                        ref={(el) => {
                          if (el) {
                            restoreCursorPosition(block.clientId, el);
                          }
                        }}
                        style={{
                          minHeight: '1.5em',
                          outline: 'none',
                          border: '1px solid transparent',
                          background: 'transparent',
                          width: '100%',
                          fontSize: 'var(--wp--preset--font-size--large)',
                          fontWeight: 'bold',
                          lineHeight: '1.3',
                          padding: '8px',
                          borderRadius: '4px',
                          direction: 'ltr',
                          unicodeBidi: 'normal'
                        }}
                      >
                        {block.attributes.content || 'Add heading...'}
                      </h2>
                    )}

                    {block.name === 'core/image' && (
                      <figure
                        key={`image-${block.clientId}`}
                        className="wp-block-image"
                        style={{
                          margin: '1em 0',
                          textAlign: 'center'
                        }}
                      >
                        <img
                          src={block.attributes.url || ''}
                          alt={block.attributes.alt || ''}
                          style={{
                            maxWidth: '100%',
                            height: 'auto',
                            borderRadius: '4px'
                          }}
                        />
                        {block.attributes.caption && (
                          <figcaption
                            contentEditable
                            suppressContentEditableWarning
                            onInput={(e) => {
                              const newCaption = e.currentTarget.textContent || '';
                              setBlocks(prevBlocks => 
                                prevBlocks.map(b => 
                                  b.clientId === block.clientId 
                                    ? { ...b, attributes: { ...b.attributes, caption: newCaption } }
                                    : b
                                )
                              );
                            }}
                            style={{
                              fontSize: 'var(--wp--preset--font-size--small)',
                              color: '#666',
                              fontStyle: 'italic',
                              textAlign: 'center',
                              marginTop: '0.5em',
                              padding: '4px 8px',
                              border: '1px solid transparent',
                              borderRadius: '4px',
                              outline: 'none'
                            }}
                          >
                            {block.attributes.caption}
                          </figcaption>
                        )}
                      </figure>
                    )}

                    {block.name === 'core/list' && (
                      <ul
                        key={`list-${block.clientId}`}
                        contentEditable
                        suppressContentEditableWarning
                        onInput={(e) => {
                          const newContent = e.currentTarget.textContent || '';
                          handleListInput(block.clientId, newContent);
                        }}
                        onFocus={(e) => {
                          e.currentTarget.style.border = '1px solid #007cba';
                        }}
                        onBlur={(e) => {
                          e.currentTarget.style.border = '1px solid transparent';
                        }}
                        style={{
                          minHeight: '1.5em',
                          outline: 'none',
                          border: '1px solid transparent',
                          background: 'transparent',
                          width: '100%',
                          fontSize: 'var(--wp--preset--font-size--medium)',
                          lineHeight: '1.5',
                          padding: '8px',
                          borderRadius: '4px',
                          direction: 'ltr',
                          unicodeBidi: 'normal'
                        }}
                      >
                        <li>{block.attributes.values || 'Add list item...'}</li>
                      </ul>
                    )}

                    {block.name === 'core/quote' && (
                      <blockquote
                        key={`quote-${block.clientId}`}
                        contentEditable
                        suppressContentEditableWarning
                        onInput={(e) => {
                          const newContent = e.currentTarget.textContent || '';
                          handleQuoteInput(block.clientId, newContent);
                        }}
                        onFocus={(e) => {
                          e.currentTarget.style.border = '1px solid #007cba';
                        }}
                        onBlur={(e) => {
                          e.currentTarget.style.border = '1px solid transparent';
                        }}
                        style={{
                          minHeight: '1.5em',
                          outline: 'none',
                          border: '1px solid transparent',
                          background: 'transparent',
                          width: '100%',
                          fontSize: 'var(--wp--preset--font-size--medium)',
                          lineHeight: '1.5',
                          padding: '8px',
                          borderRadius: '4px',
                          direction: 'ltr',
                          unicodeBidi: 'normal',
                          borderLeft: '4px solid #007cba',
                          paddingLeft: '16px',
                          fontStyle: 'italic'
                        }}
                      >
                        {block.attributes.value || 'Add quote...'}
                      </blockquote>
                    )}

                    {block.name === 'core/separator' && (
                      <hr
                        key={`separator-${block.clientId}`}
                        style={{
                          border: 'none',
                          borderTop: '1px solid #ddd',
                          margin: '2em 0',
                          height: '1px'
                        }}
                      />
                    )}
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    );
  }

  // Debug: Log blocks before rendering
  console.log('üîç Blocks before rendering:', blocks);
  console.log('üîç Block count:', blocks.length);
  console.log('üîç First few blocks:', blocks.slice(0, 3));
  
  // Debug: Log WordPress blocks format
  console.log('üîç WordPress blocks format:', wordPressBlocks);
  console.log('üîç WordPress blocks count:', wordPressBlocks.length);
  console.log('üîç First WordPress block:', wordPressBlocks[0]);

  // Final safety check - ensure components are valid before rendering
  if (!isValidComponent(SlotFillProvider) || !isValidComponent(BlockEditorProvider)) {
    console.log('‚ö†Ô∏è WordPress components not ready in main render, showing fallback UI');
    return (
      <div className="editor-visual-editor">
        <div className="editor-styles-wrapper block-editor-writing-flow">
          <div 
            className="editor-visual-editor__post-title-wrapper edit-post-visual-editor__post-title-wrapper has-global-padding"
            style={{
              maxWidth: '632px',
              margin: '33px auto 0 auto',
              padding: '0 20px'
            }}
          >
            <h1 
              contentEditable
              suppressContentEditableWarning
              className="wp-block wp-block-post-title block-editor-block-list__block editor-post-title editor-post-title__input rich-text"
              aria-label="Add title"
              onInput={(e) => setTitle(e.currentTarget.textContent || '')}
              style={{ 
                fontSize: 'var(--wp--preset--font-size--x-large)',
                fontWeight: 'bold',
                lineHeight: '1.2',
                margin: '0',
                padding: '0',
                border: 'none',
                outline: 'none',
                backgroundColor: 'transparent',
                textAlign: 'left',
                minHeight: '1.2em',
                whiteSpace: 'pre-wrap'
              }}
            >
              {title || 'Add title'}
            </h1>
          </div>

          <div 
            className="is-root-container is-desktop-preview is-layout-constrained wp-block-post-content-is-layout-constrained has-global-padding wp-block-post-content has-global-padding block-editor-block-list__layout"
            style={{
              maxWidth: '650px',
              margin: '0 auto',
              padding: '0 20px'
            }}
          >
            <div className="block-editor-block-list__layout" data-is-drop-zone="true">
              {blocks.map((block, index) => (
                <div key={`${block.clientId}-${block.name}`}>
                  <div 
                    className="block-editor-block-list__insertion-point"
                    onClick={(e) => {
                      const rect = e.currentTarget.getBoundingClientRect();
                      const clickX = rect.left + rect.width / 2;
                      const clickY = rect.top;
                      const { popupX, popupY } = calculatePopupPosition();
                      
                      setInserterPosition({ 
                        index, 
                        x: clickX, 
                        y: clickY,
                        popupX,
                        popupY
                      });
                      setShowBlockInserter(true);
                    }}
                  >
                    <div className="plus-icon"></div>
                  </div>
                  
                  <div style={{ marginBottom: '1rem' }}>
                    {block.name === 'core/paragraph' && (
                      <div
                        key={`paragraph-${block.clientId}`}
                        contentEditable
                        suppressContentEditableWarning
                        onInput={(e) => {
                          const newContent = e.currentTarget.textContent || '';
                          handleParagraphInput(block.clientId, newContent, e.currentTarget);
                        }}
                        onFocus={(e) => {
                          e.currentTarget.style.border = '1px solid #007cba';
                        }}
                        onBlur={(e) => {
                          e.currentTarget.style.border = '1px solid transparent';
                        }}
                        ref={(el) => {
                          if (el) {
                            restoreCursorPosition(block.clientId, el);
                          }
                        }}
                        style={{
                          minHeight: '1.5em',
                          outline: 'none',
                          border: '1px solid transparent',
                          background: 'transparent',
                          width: '100%',
                          fontSize: 'var(--wp--preset--font-size--medium)',
                          lineHeight: '1.5',
                          padding: '8px',
                          borderRadius: '4px',
                          direction: 'ltr',
                          unicodeBidi: 'normal'
                        }}
                      >
                        {block.attributes.content || 'Start writing...'}
                      </div>
                    )}

                    {block.name === 'core/heading' && (
                      <h2
                        key={`heading-${block.clientId}`}
                        contentEditable
                        suppressContentEditableWarning
                        onInput={(e) => {
                          const newContent = e.currentTarget.textContent || '';
                          handleHeadingInput(block.clientId, newContent, e.currentTarget);
                        }}
                        onFocus={(e) => {
                          e.currentTarget.style.border = '1px solid #007cba';
                        }}
                        onBlur={(e) => {
                          e.currentTarget.style.border = '1px solid transparent';
                        }}
                        ref={(el) => {
                          if (el) {
                            restoreCursorPosition(block.clientId, el);
                          }
                        }}
                        style={{
                          minHeight: '1.5em',
                          outline: 'none',
                          border: '1px solid transparent',
                          background: 'transparent',
                          width: '100%',
                          fontSize: 'var(--wp--preset--font-size--large)',
                          fontWeight: 'bold',
                          lineHeight: '1.3',
                          padding: '8px',
                          borderRadius: '4px',
                          direction: 'ltr',
                          unicodeBidi: 'normal'
                        }}
                      >
                        {block.attributes.content || 'Add heading...'}
                      </h2>
                    )}

                    {block.name === 'core/image' && (
                      <figure
                        key={`image-${block.clientId}`}
                        className="wp-block-image"
                        style={{
                          margin: '1em 0',
                          textAlign: 'center'
                        }}
                      >
                        <img
                          src={block.attributes.url || ''}
                          alt={block.attributes.alt || ''}
                          style={{
                            maxWidth: '100%',
                            height: 'auto',
                            borderRadius: '4px'
                          }}
                        />
                        {block.attributes.caption && (
                          <figcaption
                            contentEditable
                            suppressContentEditableWarning
                            onInput={(e) => {
                              const newCaption = e.currentTarget.textContent || '';
                              setBlocks(prevBlocks => 
                                prevBlocks.map(b => 
                                  b.clientId === block.clientId 
                                    ? { ...b, attributes: { ...b.attributes, caption: newCaption } }
                                    : b
                                )
                              );
                            }}
                            style={{
                              fontSize: 'var(--wp--preset--font-size--small)',
                              color: '#666',
                              fontStyle: 'italic',
                              textAlign: 'center',
                              marginTop: '0.5em',
                              padding: '4px 8px',
                              border: '1px solid transparent',
                              borderRadius: '4px',
                              outline: 'none'
                            }}
                          >
                            {block.attributes.caption}
                          </figcaption>
                        )}
                      </figure>
                    )}

                    {block.name === 'core/list' && (
                      <ul
                        key={`list-${block.clientId}`}
                        contentEditable
                        suppressContentEditableWarning
                        onInput={(e) => {
                          const newContent = e.currentTarget.textContent || '';
                          handleListInput(block.clientId, newContent);
                        }}
                        onFocus={(e) => {
                          e.currentTarget.style.border = '1px solid #007cba';
                        }}
                        onBlur={(e) => {
                          e.currentTarget.style.border = '1px solid transparent';
                        }}
                        style={{
                          minHeight: '1.5em',
                          outline: 'none',
                          border: '1px solid transparent',
                          background: 'transparent',
                          width: '100%',
                          fontSize: 'var(--wp--preset--font-size--medium)',
                          lineHeight: '1.5',
                          padding: '8px',
                          borderRadius: '4px',
                          direction: 'ltr',
                          unicodeBidi: 'normal'
                        }}
                      >
                        <li>{block.attributes.values || 'Add list item...'}</li>
                      </ul>
                    )}

                    {block.name === 'core/quote' && (
                      <blockquote
                        key={`quote-${block.clientId}`}
                        contentEditable
                        suppressContentEditableWarning
                        onInput={(e) => {
                          const newContent = e.currentTarget.textContent || '';
                          handleQuoteInput(block.clientId, newContent);
                        }}
                        onFocus={(e) => {
                          e.currentTarget.style.border = '1px solid #007cba';
                        }}
                        onBlur={(e) => {
                          e.currentTarget.style.border = '1px solid transparent';
                        }}
                        style={{
                          minHeight: '1.5em',
                          outline: 'none',
                          border: '1px solid transparent',
                          background: 'transparent',
                          width: '100%',
                          fontSize: 'var(--wp--preset--font-size--medium)',
                          lineHeight: '1.5',
                          padding: '8px',
                          borderRadius: '4px',
                          direction: 'ltr',
                          unicodeBidi: 'normal',
                          borderLeft: '4px solid #007cba',
                          paddingLeft: '16px',
                          fontStyle: 'italic'
                        }}
                      >
                        {block.attributes.value || 'Add quote...'}
                      </blockquote>
                    )}

                    {block.name === 'core/separator' && (
                      <hr
                        key={`separator-${block.clientId}`}
                        style={{
                          border: 'none',
                          borderTop: '1px solid #ddd',
                          margin: '2em 0',
                          height: '1px'
                        }}
                      />
                    )}
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="block-editor__container hide-if-no-js">
      <div className="interface-interface-skeleton">
        {/* WordPress-style Header */}
        <div className="interface-interface-skeleton__header">
          <div className="editor-header">
            <div className="editor-header__settings">
              <button 
                onClick={handleSave}
                className="components-button editor-post-publish-button editor-post-publish-button__button is-primary is-compact"
              >
                Save
              </button>
              <button 
                onClick={onCancel}
                className="components-button is-compact"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>

        {/* WordPress-style Body */}
        <div className="interface-interface-skeleton__body">
          <div className="interface-interface-skeleton__content">
            {SlotFillProvider && BlockEditorProvider ? (
              <SlotFillProvider>
                <BlockEditorProvider
                  value={wordPressBlocks}
                  onChange={handleBlocksChange}
                  settings={blockEditorSettings}
                  useSubRegistry={false}
                >
                {/* WordPress-style Editor Container */}
                <div className="editor-visual-editor">
                  <div className="editor-styles-wrapper block-editor-writing-flow">
                    {/* Post Title Input */}
                    <div 
                      className="editor-visual-editor__post-title-wrapper edit-post-visual-editor__post-title-wrapper has-global-padding"
                      style={{
                        maxWidth: '632px',
                        margin: '33px auto 0 auto',
                        padding: '0 20px'
                      }}
                    >
                      <h1 
                        contentEditable
                        suppressContentEditableWarning
                        className="wp-block wp-block-post-title block-editor-block-list__block editor-post-title editor-post-title__input rich-text"
                        aria-label="Add title"
                        onInput={(e) => setTitle(e.currentTarget.textContent || '')}
                        style={{ 
                          fontSize: 'var(--wp--preset--font-size--x-large)',
                          fontWeight: 'bold',
                          lineHeight: '1.2',
                          margin: '0',
                          padding: '0',
                          border: 'none',
                          outline: 'none',
                          backgroundColor: 'transparent',
                          textAlign: 'left',
                          minHeight: '1.2em',
                          whiteSpace: 'pre-wrap'
                        }}
                      >
                        {title || 'Add title'}
                      </h1>
                    </div>

                    {/* Editor Content using WordPress's official components */}
                    <div 
                      className="is-root-container is-desktop-preview is-layout-constrained wp-block-post-content-is-layout-constrained has-global-padding wp-block-post-content has-global-padding block-editor-block-list__layout"
                      style={{
                        maxWidth: '650px',
                        margin: '0 auto',
                        padding: '0 20px'
                      }}
                    >
                      {/* Custom block list with insertion points */}
                      <div className="block-editor-block-list__layout" data-is-drop-zone="true">
                        {blocks.map((block, index) => (
                          <div key={`${block.clientId}-${block.name}`}>
                            {/* Insertion point before each block */}
                            <div 
                              className="block-editor-block-list__insertion-point"
                              onClick={(e) => {
                                const rect = e.currentTarget.getBoundingClientRect();
                                const clickX = rect.left + rect.width / 2;
                                const clickY = rect.top;
                                const { popupX, popupY } = calculatePopupPosition();
                                
                                setInserterPosition({ 
                                  index, 
                                  x: clickX, 
                                  y: clickY,
                                  popupX,
                                  popupY
                                });
                                setShowBlockInserter(true);
                              }}
                            >
                              <div className="plus-icon"></div>
                            </div>
                            
                            {/* Block content */}
                            <div style={{ marginBottom: '1rem' }}>
                              {block.name === 'core/paragraph' && (
                                <div
                                  key={`paragraph-${block.clientId}`}
                                  contentEditable
                                  suppressContentEditableWarning
                                      onInput={(e) => {
                                        const newContent = e.currentTarget.textContent || '';
                                        handleHeadingInput(block.clientId, newContent, e.currentTarget);
                                      }}
                                      onFocus={(e) => {
                                        e.currentTarget.style.border = '1px solid #007cba';
                                      }}
                                      onBlur={(e) => {
                                        e.currentTarget.style.border = '1px solid transparent';
                                      }}
                                      ref={(el) => {
                                        if (el) {
                                          restoreCursorPosition(block.clientId, el);
                                        }
                                      }}
                                      style={{
                                        minHeight: '1.2em',
                                        outline: 'none',
                                        border: '1px solid transparent',
                                        background: 'transparent',
                                        width: '100%',
                                        fontSize: 'var(--wp--preset--font-size--large)',
                                        fontWeight: '800',
                                        lineHeight: '1.2',
                                        margin: '0',
                                        padding: '8px',
                                        borderRadius: '4px',
                                        direction: 'ltr',
                                        unicodeBidi: 'normal'
                                      }}
                                    >
                                      {block.attributes.content || 'Heading'}
                                    </h2>
                                  )}

                                  {block.name === 'core/image' && (
                                  <figure
                                    key={`image-${block.clientId}`}
                                    className="wp-block-image"
                                    style={{
                                      margin: '1em 0',
                                      textAlign: 'center',
                                      padding: '8px',
                                      border: '1px solid transparent',
                                      borderRadius: '4px'
                                    }}
                                  >
                                      {block.attributes.url ? (
                                        <img 
                                          src={block.attributes.url} 
                                          alt={block.attributes.alt || ''} 
                                        style={{ 
                                          maxWidth: '100%', 
                                          height: 'auto',
                                          borderRadius: '4px'
                                        }}
                                        />
                                      ) : (
                                        <div style={{ 
                                          border: '2px dashed #ccc', 
                                          padding: '40px', 
                                          textAlign: 'center',
                                          backgroundColor: '#f9f9f9',
                                          color: '#666'
                                        }}>
                                          No image selected
                                        </div>
                                      )}
                                      {block.attributes.caption && (
                                      <figcaption
                                        contentEditable
                                        suppressContentEditableWarning
                                        onInput={(e) => {
                                          const newCaption = e.currentTarget.textContent || '';
                                          setBlocks(prevBlocks => 
                                            prevBlocks.map(b => 
                                              b.clientId === block.clientId 
                                                ? { ...b, attributes: { ...b.attributes, caption: newCaption } }
                                                : b
                                            )
                                          );
                                        }}
                                        style={{ 
                                          fontSize: 'var(--wp--preset--font-size--small)',
                                          color: '#666',
                                          fontStyle: 'italic',
                                          textAlign: 'center',
                                          marginTop: '0.5em',
                                          padding: '4px 8px',
                                          border: '1px solid transparent',
                                          borderRadius: '4px',
                                          outline: 'none'
                                        }}
                                      >
                                          {block.attributes.caption}
                                        </figcaption>
                                      )}
                                  </figure>
                                  )}

                                  {block.name === 'core/list' && (
                                    <div
                                      contentEditable
                                      suppressContentEditableWarning
                                      onInput={(e) => {
                                        const newContent = e.currentTarget.innerHTML;
                                        handleListInput(block.clientId, newContent);
                                      }}
                                      style={{
                                        outline: 'none',
                                        border: '1px solid transparent',
                                        background: 'transparent',
                                        width: '100%',
                                        fontSize: 'var(--wp--preset--font-size--medium)',
                                        lineHeight: '1.5',
                                        padding: '8px 8px 8px 1.5em',
                                        borderRadius: '4px'
                                      }}
                                      onFocus={(e) => {
                                        e.currentTarget.style.border = '1px solid #007cba';
                                      }}
                                      onBlur={(e) => {
                                        e.currentTarget.style.border = '1px solid transparent';
                                      }}
                                      dangerouslySetInnerHTML={{ __html: block.attributes.values || '<li>List item</li>' }}
                                    />
                                  )}

                                  {block.name === 'core/quote' && (
                                    <blockquote style={{ 
                                      borderLeft: '4px solid var(--wp--preset--color--primary)',
                                      paddingLeft: 'var(--wp--preset--spacing--40)',
                                      margin: 'var(--wp--style--block-gap) 0',
                                      fontStyle: 'italic',
                                      fontSize: 'var(--wp--preset--font-size--medium)',
                                      lineHeight: '1.6',
                                      padding: '8px',
                                      border: '1px solid transparent',
                                      borderRadius: '4px'
                                    }}>
                                      <div
                                        contentEditable
                                        suppressContentEditableWarning
                                        onInput={(e) => {
                                          const newContent = e.currentTarget.innerHTML;
                                          handleQuoteInput(block.clientId, newContent);
                                        }}
                                        style={{
                                          outline: 'none',
                                          border: 'none',
                                          background: 'transparent',
                                          width: '100%',
                                          margin: '0'
                                        }}
                                        onFocus={(e) => {
                                          e.currentTarget.parentElement!.style.border = '1px solid #007cba';
                                        }}
                                        onBlur={(e) => {
                                          e.currentTarget.parentElement!.style.border = '1px solid transparent';
                                        }}
                                        dangerouslySetInnerHTML={{ __html: block.attributes.value || '<p>Quote text</p>' }}
                                      />
                                      {block.attributes.citation && (
                                        <cite style={{ 
                                          display: 'block',
                                          marginTop: 'var(--wp--preset--spacing--30)',
                                          fontSize: 'var(--wp--preset--font-size--small)',
                                          fontStyle: 'normal'
                                        }}>
                                          ‚Äî {block.attributes.citation}
                                        </cite>
                                      )}
                                    </blockquote>
                                  )}

                                  {block.name === 'core/separator' && (
                                    <hr style={{ 
                                      border: 'none',
                                      borderTop: '1px solid #ddd',
                                      margin: '2em 0',
                                      height: '1px'
                                    }} />
                                  )}
                                </div>
                              </div>
                            ))}
                            
                            {/* Insertion point after the last block */}
                            <div 
                              className="block-editor-block-list__insertion-point"
                              onClick={(e) => {
                                const rect = e.currentTarget.getBoundingClientRect();
                                const clickX = rect.left + rect.width / 2;
                                const clickY = rect.top;
                                const { popupX, popupY } = calculatePopupPosition();
                                
                                setInserterPosition({ 
                                  index: blocks.length, 
                                  x: clickX, 
                                  y: clickY,
                                  popupX,
                                  popupY
                                });
                                setShowBlockInserter(true);
                              }}
                            >
                              <div className="plus-icon"></div>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                </div>
                </BlockEditorProvider>
              </SlotFillProvider>
            ) : (
              <div className="editor-visual-editor">
                <div className="editor-styles-wrapper block-editor-writing-flow">
                  <div 
                    className="editor-visual-editor__post-title-wrapper edit-post-visual-editor__post-title-wrapper has-global-padding"
                    style={{
                      maxWidth: '632px',
                      margin: '33px auto 0 auto',
                      padding: '0 20px'
                    }}
                  >
                    <h1 
                      contentEditable
                      suppressContentEditableWarning
                      className="wp-block wp-block-post-title block-editor-block-list__block editor-post-title editor-post-title__input rich-text"
                      aria-label="Add title"
                      onInput={(e) => setTitle(e.currentTarget.textContent || '')}
                      style={{ 
                        fontSize: 'var(--wp--preset--font-size--x-large)',
                        fontWeight: 'bold',
                        lineHeight: '1.2',
                        margin: '0',
                        padding: '0',
                        border: 'none',
                        outline: 'none',
                        backgroundColor: 'transparent',
                        textAlign: 'left',
                        minHeight: '1.2em',
                        whiteSpace: 'pre-wrap'
                      }}
                    >
                      {title || 'Add title'}
                    </h1>
                  </div>

                  <div 
                    className="is-root-container is-desktop-preview is-layout-constrained wp-block-post-content-is-layout-constrained has-global-padding wp-block-post-content has-global-padding block-editor-block-list__layout"
                    style={{
                      maxWidth: '650px',
                      margin: '0 auto',
                      padding: '0 20px'
                    }}
                  >
                    <div className="block-editor-block-list__layout" data-is-drop-zone="true">
                      {blocks.map((block, index) => (
                        <div key={`${block.clientId}-${block.name}`}>
                          <div 
                            className="block-editor-block-list__insertion-point"
                            onClick={(e) => {
                              const rect = e.currentTarget.getBoundingClientRect();
                              const clickX = rect.left + rect.width / 2;
                              const clickY = rect.top;
                              const { popupX, popupY } = calculatePopupPosition();
                              
                              setInserterPosition({ 
                                index, 
                                x: clickX, 
                                y: clickY,
                                popupX,
                                popupY
                              });
                              setShowBlockInserter(true);
                            }}
                          >
                            <div className="plus-icon"></div>
                          </div>
                          
                          <div style={{ marginBottom: '1rem' }}>
                            {block.name === 'core/paragraph' && (
                              <div
                                key={`paragraph-${block.clientId}`}
                                contentEditable
                                suppressContentEditableWarning
                                onInput={(e) => {
                                  const newContent = e.currentTarget.textContent || '';
                                  handleParagraphInput(block.clientId, newContent, e.currentTarget);
                                }}
                                onFocus={(e) => {
                                  e.currentTarget.style.border = '1px solid #007cba';
                                }}
                                onBlur={(e) => {
                                  e.currentTarget.style.border = '1px solid transparent';
                                }}
                                ref={(el) => {
                                  if (el) {
                                    restoreCursorPosition(block.clientId, el);
                                  }
                                }}
                                style={{
                                  minHeight: '1.5em',
                                  outline: 'none',
                                  border: '1px solid transparent',
                                  background: 'transparent',
                                  width: '100%',
                                  fontSize: 'var(--wp--preset--font-size--medium)',
                                  lineHeight: '1.5',
                                  padding: '8px',
                                  borderRadius: '4px',
                                  direction: 'ltr',
                                  unicodeBidi: 'normal'
                                }}
                              >
                                {block.attributes.content || 'Start writing...'}
                              </div>
                            )}

                            {block.name === 'core/heading' && (
                              <h2
                                key={`heading-${block.clientId}`}
                                contentEditable
                                suppressContentEditableWarning
                                onInput={(e) => {
                                  const newContent = e.currentTarget.textContent || '';
                                  handleHeadingInput(block.clientId, newContent, e.currentTarget);
                                }}
                                onFocus={(e) => {
                                  e.currentTarget.style.border = '1px solid #007cba';
                                }}
                                onBlur={(e) => {
                                  e.currentTarget.style.border = '1px solid transparent';
                                }}
                                ref={(el) => {
                                  if (el) {
                                    restoreCursorPosition(block.clientId, el);
                                  }
                                }}
                                style={{
                                  minHeight: '1.5em',
                                  outline: 'none',
                                  border: '1px solid transparent',
                                  background: 'transparent',
                                  width: '100%',
                                  fontSize: 'var(--wp--preset--font-size--large)',
                                  fontWeight: 'bold',
                                  lineHeight: '1.3',
                                  padding: '8px',
                                  borderRadius: '4px',
                                  direction: 'ltr',
                                  unicodeBidi: 'normal'
                                }}
                              >
                                {block.attributes.content || 'Add heading...'}
                              </h2>
                            )}

                            {block.name === 'core/image' && (
                              <figure
                                key={`image-${block.clientId}`}
                                className="wp-block-image"
                                style={{
                                  margin: '1em 0',
                                  textAlign: 'center'
                                }}
                              >
                                <img
                                  src={block.attributes.url || ''}
                                  alt={block.attributes.alt || ''}
                                  style={{
                                    maxWidth: '100%',
                                    height: 'auto',
                                    borderRadius: '4px'
                                  }}
                                />
                                {block.attributes.caption && (
                                  <figcaption
                                    contentEditable
                                    suppressContentEditableWarning
                                    onInput={(e) => {
                                      const newCaption = e.currentTarget.textContent || '';
                                      setBlocks(prevBlocks => 
                                        prevBlocks.map(b => 
                                          b.clientId === block.clientId 
                                            ? { ...b, attributes: { ...b.attributes, caption: newCaption } }
                                            : b
                                        )
                                      );
                                    }}
                                    style={{
                                      fontSize: 'var(--wp--preset--font-size--small)',
                                      color: '#666',
                                      fontStyle: 'italic',
                                      textAlign: 'center',
                                      marginTop: '0.5em',
                                      padding: '4px 8px',
                                      border: '1px solid transparent',
                                      borderRadius: '4px',
                                      outline: 'none'
                                    }}
                                  >
                                    {block.attributes.caption}
                                  </figcaption>
                                )}
                              </figure>
                            )}

                            {block.name === 'core/list' && (
                              <ul
                                key={`list-${block.clientId}`}
                                contentEditable
                                suppressContentEditableWarning
                                onInput={(e) => {
                                  const newContent = e.currentTarget.textContent || '';
                                  handleListInput(block.clientId, newContent);
                                }}
                                onFocus={(e) => {
                                  e.currentTarget.style.border = '1px solid #007cba';
                                }}
                                onBlur={(e) => {
                                  e.currentTarget.style.border = '1px solid transparent';
                                }}
                                style={{
                                  minHeight: '1.5em',
                                  outline: 'none',
                                  border: '1px solid transparent',
                                  background: 'transparent',
                                  width: '100%',
                                  fontSize: 'var(--wp--preset--font-size--medium)',
                                  lineHeight: '1.5',
                                  padding: '8px',
                                  borderRadius: '4px',
                                  direction: 'ltr',
                                  unicodeBidi: 'normal'
                                }}
                              >
                                <li>{block.attributes.values || 'Add list item...'}</li>
                              </ul>
                            )}

                            {block.name === 'core/quote' && (
                              <blockquote
                                key={`quote-${block.clientId}`}
                                contentEditable
                                suppressContentEditableWarning
                                onInput={(e) => {
                                  const newContent = e.currentTarget.textContent || '';
                                  handleQuoteInput(block.clientId, newContent);
                                }}
                                onFocus={(e) => {
                                  e.currentTarget.style.border = '1px solid #007cba';
                                }}
                                onBlur={(e) => {
                                  e.currentTarget.style.border = '1px solid transparent';
                                }}
                                style={{
                                  minHeight: '1.5em',
                                  outline: 'none',
                                  border: '1px solid transparent',
                                  background: 'transparent',
                                  width: '100%',
                                  fontSize: 'var(--wp--preset--font-size--medium)',
                                  lineHeight: '1.5',
                                  padding: '8px',
                                  borderRadius: '4px',
                                  direction: 'ltr',
                                  unicodeBidi: 'normal',
                                  borderLeft: '4px solid #007cba',
                                  paddingLeft: '16px',
                                  fontStyle: 'italic'
                                }}
                              >
                                {block.attributes.value || 'Add quote...'}
                              </blockquote>
                            )}

                            {block.name === 'core/separator' && (
                              <hr
                                key={`separator-${block.clientId}`}
                                style={{
                                  border: 'none',
                                  borderTop: '1px solid #ddd',
                                  margin: '2em 0',
                                  height: '1px'
                                }}
                              />
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Block Inserter Popover */}
      {showBlockInserter && inserterPosition && (
        <div
          className="components-popover block-editor-inserter__popover"
          style={{
            position: 'fixed',
            top: inserterPosition.popupY,
            left: inserterPosition.popupX,
            zIndex: 1000000,
            width: '650px',
            maxWidth: '90vw',
            boxShadow: '0 3px 30px rgba(25, 30, 35, 0.2)',
            borderRadius: '8px',
            border: '1px solid #ddd',
            backgroundColor: 'white',
            padding: '16px',
            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif'
          }}
        >
          <div className="block-editor-inserter__quick-inserter">
            <div className="block-editor-inserter__search" style={{ marginBottom: '8px' }}>
              <input
                type="text"
                placeholder="Search for an image..."
                value={inserterSearchQuery}
                onChange={(e) => {
                  const query = e.target.value;
                  setInserterSearchQuery(query);
                  if (query.trim()) {
                    handleInserterImageSearch(query);
                  } else {
                    setShowImageResults(false);
                  }
                }}
                style={{
                  width: '100%',
                  padding: '8px 12px',
                  border: '1px solid #ddd',
                  borderRadius: '4px',
                  fontSize: '14px',
                  outline: 'none'
                }}
                onFocus={(e) => e.currentTarget.style.borderColor = '#007cba'}
                onBlur={(e) => e.currentTarget.style.borderColor = '#ddd'}
              />
            </div>

            {/* Gray line above API buttons */}
            <div style={{ 
              borderTop: '1px solid #e0e0e0', 
              marginTop: '4px',
              marginBottom: '4px'
            }}></div>

            {/* API Selection Buttons */}
            <div className="block-editor-inserter__block-list" style={{ marginBottom: '4px' }}>
              <div className="block-editor-block-types-list">
                <div 
                  className="block-editor-block-types-list__item" 
                  style={{ 
                    display: 'flex', 
                    alignItems: 'center', 
                    justifyContent: 'center',
                    padding: '8px 12px', 
                    cursor: 'pointer', 
                    border: '1px solid transparent', 
                    borderRadius: '4px', 
                    marginBottom: '2px', 
                    transition: '0.2s',
                    backgroundColor: selectedSources.includes('unsplash') ? '#e3f2fd' : 'transparent'
                  }}
                  onClick={() => handleSourceToggle('unsplash')}
                  onMouseEnter={(e) => {
                    if (!selectedSources.includes('unsplash')) {
                      e.currentTarget.style.backgroundColor = '#f5f5f5';
                    }
                  }}
                  onMouseLeave={(e) => {
                    if (!selectedSources.includes('unsplash')) {
                      e.currentTarget.style.backgroundColor = 'transparent';
                    }
                  }}
                >
                  <div style={{ fontWeight: '600', fontSize: '14px', color: 'rgb(30, 30, 30)' }}>Unsplash</div>
                </div>
                
                <div 
                  className="block-editor-block-types-list__item" 
                  style={{ 
                    display: 'flex', 
                    alignItems: 'center', 
                    justifyContent: 'center',
                    padding: '8px 12px', 
                    cursor: 'pointer', 
                    border: '1px solid transparent', 
                    borderRadius: '4px', 
                    marginBottom: '2px', 
                    transition: '0.2s',
                    backgroundColor: selectedSources.includes('pexels') ? '#e3f2fd' : 'transparent'
                  }}
                  onClick={() => handleSourceToggle('pexels')}
                  onMouseEnter={(e) => {
                    if (!selectedSources.includes('pexels')) {
                      e.currentTarget.style.backgroundColor = '#f5f5f5';
                    }
                  }}
                  onMouseLeave={(e) => {
                    if (!selectedSources.includes('pexels')) {
                      e.currentTarget.style.backgroundColor = 'transparent';
                    }
                  }}
                >
                  <div style={{ fontWeight: '600', fontSize: '14px', color: 'rgb(30, 30, 30)' }}>Pexels</div>
                </div>
                
                <div 
                  className="block-editor-block-types-list__item" 
                  style={{ 
                    display: 'flex', 
                    alignItems: 'center', 
                    justifyContent: 'center',
                    padding: '8px 12px', 
                    cursor: 'pointer', 
                    border: '1px solid transparent', 
                    borderRadius: '4px', 
                    marginBottom: '2px', 
                    transition: '0.2s',
                    backgroundColor: selectedSources.includes('wikiCommons') ? '#e3f2fd' : 'transparent'
                  }}
                  onClick={() => handleSourceToggle('wikiCommons')}
                  onMouseEnter={(e) => {
                    if (!selectedSources.includes('wikiCommons')) {
                      e.currentTarget.style.backgroundColor = '#f5f5f5';
                    }
                  }}
                  onMouseLeave={(e) => {
                    if (!selectedSources.includes('wikiCommons')) {
                      e.currentTarget.style.backgroundColor = 'transparent';
                    }
                  }}
                >
                  <div style={{ fontWeight: '600', fontSize: '14px', color: 'rgb(30, 30, 30)' }}>Wiki Commons</div>
                </div>
              </div>
            </div>

            {/* Gray line below API buttons */}
            <div style={{ 
              borderTop: '1px solid #e0e0e0', 
              marginTop: '4px',
              marginBottom: '4px'
            }}></div>
            
            <div className="block-editor-inserter__block-list">
              {showImageResults && inserterImages.length > 0 ? (
                <div>
                  <div style={{ 
                    fontSize: '14px', 
                    fontWeight: '600', 
                    color: '#1e1e1e', 
                    marginBottom: '12px',
                    padding: '8px 0',
                    borderBottom: '1px solid #e0e0e0'
                  }}>
                    Image Results for "{inserterSearchQuery}"
                  </div>
                  <div style={{ 
                    display: 'grid', 
                    gridTemplateColumns: 'repeat(auto-fill, minmax(120px, 1fr))', 
                    gap: '8px',
                    maxHeight: '300px',
                    overflowY: 'auto'
                  }}>
                    {inserterImages.map((image, index) => (
                      <div
                        key={`${image.url}-${index}`}
                        onClick={() => handleInserterImageSelect(image)}
                        style={{
                          cursor: 'pointer',
                          border: '1px solid #ddd',
                          borderRadius: '4px',
                          overflow: 'hidden',
                          transition: 'all 0.2s ease'
                        }}
                        onMouseEnter={(e) => {
                          e.currentTarget.style.borderColor = '#007cba';
                          e.currentTarget.style.transform = 'scale(1.02)';
                        }}
                        onMouseLeave={(e) => {
                          e.currentTarget.style.borderColor = '#ddd';
                          e.currentTarget.style.transform = 'scale(1)';
                        }}
                      >
                        <img
                          src={image.thumbnail || image.url}
                          alt={image.caption || 'Image'}
                          style={{
                            width: '100%',
                            height: '80px',
                            objectFit: 'cover',
                            display: 'block'
                          }}
                        />
                        <div style={{
                          padding: '4px 6px',
                          fontSize: '10px',
                          color: '#666',
                          lineHeight: '1.2',
                          overflow: 'hidden',
                          textOverflow: 'ellipsis',
                          whiteSpace: 'nowrap'
                        }}>
                          {image.attribution || image.caption || 'Image'}
                        </div>
                      </div>
                    ))}
                  </div>
                  
                  {/* Load More Button */}
                  {inserterHasMore && (
                    <div style={{ 
                      textAlign: 'center', 
                      marginTop: '12px',
                      padding: '8px 0',
                      borderTop: '1px solid #e0e0e0'
                    }}>
                      <button
                        onClick={handleLoadMoreImages}
                        disabled={inserterLoading}
                        style={{
                          padding: '8px 16px',
                          backgroundColor: inserterLoading ? '#f5f5f5' : '#007cba',
                          color: inserterLoading ? '#999' : 'white',
                          border: 'none',
                          borderRadius: '4px',
                          cursor: inserterLoading ? 'not-allowed' : 'pointer',
                          fontSize: '14px',
                          fontWeight: '500',
                          transition: 'all 0.2s ease'
                        }}
                        onMouseEnter={(e) => {
                          if (!inserterLoading) {
                            e.currentTarget.style.backgroundColor = '#005a87';
                          }
                        }}
                        onMouseLeave={(e) => {
                          if (!inserterLoading) {
                            e.currentTarget.style.backgroundColor = '#007cba';
                          }
                        }}
                      >
                        {inserterLoading ? 'Loading...' : 'Load More Images'}
                      </button>
                    </div>
                  )}
                </div>
              ) : showImageResults && inserterLoading ? (
                <div style={{ 
                  textAlign: 'center', 
                  padding: '20px',
                  color: '#666'
                }}>
                  Searching for images...
                </div>
              ) : showImageResults && inserterImages.length === 0 ? (
                <div style={{ 
                  textAlign: 'center', 
                  padding: '20px',
                  color: '#666'
                }}>
                  No images found for "{inserterSearchQuery}"
                </div>
              ) : (
                <div className="block-editor-block-types-list" style={{
                  display: 'grid',
                  gridTemplateColumns: 'repeat(3, 1fr)',
                  gap: '8px',
                  padding: '8px'
                }}>
                  {blockTypes.map((blockType) => (
                    <div
                      key={blockType.name}
                      className="block-editor-block-types-list__item"
                      onClick={() => handleInsertBlock(blockType.name, inserterPosition.index)}
                      style={{
                        display: 'flex',
                        flexDirection: 'column',
                        alignItems: 'center',
                        padding: '16px 8px',
                        cursor: 'pointer',
                        border: '1px solid transparent',
                        borderRadius: '4px',
                        transition: 'all 0.2s ease',
                        minHeight: '80px',
                        justifyContent: 'center',
                        width: '100%'
                      }}
                      onMouseEnter={(e) => {
                        e.currentTarget.style.backgroundColor = '#f0f0f0';
                        e.currentTarget.style.borderColor = '#007cba';
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.backgroundColor = 'transparent';
                        e.currentTarget.style.borderColor = 'transparent';
                      }}
                    >
                      <div style={{ 
                        marginBottom: '8px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center'
                      }}>
                        <blockType.icon size={24} style={{ color: '#666' }} />
                      </div>
                      <div style={{ 
                        fontWeight: '500', 
                        fontSize: '13px', 
                        color: '#1e1e1e',
                        textAlign: 'center'
                      }}>
                        {blockType.title}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>
      )}


      {/* Image Search Modal */}
      <ImageSearchModal
        isOpen={showImageSearch}
        onClose={closeImageSearch}
        onSelect={handleImageSelect}
        selectedSources={selectedSources}
        onSourceToggle={handleSourceToggle}
        onSearch={handleImageSearch}
        images={searchImages}
        loading={searchLoading}
        hasMore={hasMoreImages}
        loadMore={() => handleImageSearch(lastSearchQuery, true)}
      />
      
      {/* Crop Modal */}
      <CropModal
        isOpen={showCropModal}
        imageSrc={currentImageToCrop?.full || currentImageToCrop?.url || ''}
        onCancel={() => {
          console.log('‚ùå Crop modal cancelled');
          setShowCropModal(false);
          setCurrentImageToCrop(null);
          setCurrentBlockId(null);
          setPendingImageInsertion(null);
          setCropLoading(false);
        }}
        onConfirm={handleCropConfirm}
        loading={cropLoading}
      />
    </div>
  );
}

export default WordPressBlockEditor;
